import{r as n,j as t}from"./index-CIgUH_ON.js";import{e as q,F as K,j as T,k as _,B as M,d as g,m as P,l as $}from"./Footer-Dm_9wlKh.js";import{N as z,a as l,S as G,M as H}from"./Navbar-CMAuYQ4r.js";import{F as J}from"./Table-CyB_7fbP.js";import{s as m}from"./index-DbF_Bpw-.js";import"./index-BOzfgrDM.js";import"./index-D5WSpubm.js";import"./EyeOutlined-BWV4nvJ0.js";const y=["201","202","203","204","205","206","207","208","309","310","311","312","313","314","315","316","225","226","227","228","329","330","331","332"],S={มกราคม:1,กุมภาพันธ์:2,มีนาคม:3,เมษายน:4,พฤษภาคม:5,มิถุนายน:6,กรกฎาคม:7,สิงหาคม:8,กันยายน:9,ตุลาคม:10,พฤศจิกายน:11,ธันวาคม:12},se=()=>{const[c,I]=n.useState([]),[D,u]=n.useState([]),[F,w]=n.useState(!0),[j,k]=n.useState(null),[h,O]=n.useState(void 0),[p,E]=n.useState(void 0),[f,L]=n.useState(void 0),[R,v]=n.useState(null),[A,C]=n.useState(!1),d=q();n.useEffect(()=>{(async()=>{w(!0);try{const o=T(d,"payments"),s=(await _(o)).docs.map(a=>({id:a.id,...a.data()}));s.sort((a,r)=>a.year===r.year?a.month===r.month?y.indexOf(a.room)-y.indexOf(r.room):S[a.month]-S[r.month]:a.year-r.year),I(s),u(s)}catch(o){console.error("Error fetching payment history: ",o),m.error("Failed to load payment data.")}finally{w(!1)}})()},[d]),n.useEffect(()=>{u(c.filter(e=>{const o=h?e.room===h:!0,i=p?e.year===p:!0,s=f?e.month===f:!0;return o&&i&&s}))},[h,p,f,c]);const B=async(e,o)=>{k(e);const i=o==="จ่ายแล้ว"?"ค้างชำระ":"จ่ายแล้ว";try{const s=g(d,"payments",e);await P(s,{roomStatus:i});const a=c.find(r=>r.id===e);if(a){const r=g(d,"invoices",a.invoiceId);await P(r,{roomStatus:i})}u(r=>r.map(x=>x.id===e?{...x,roomStatus:i}:x)),m.success("อัปเดตสถานะเรียบร้อยแล้ว.")}catch(s){console.error("เกิดข้อผิดพลาดในการอัปเดตสถานะ: ",s),m.error("ไม่สามารถอัปเดตสถานะได้.")}finally{k(null)}},N=async e=>{if(window.confirm("Are you sure you want to delete this payment record?"))try{const i=g(d,"payments",e);await $(i),u(s=>s.filter(a=>a.id!==e)),m.success("Payment record deleted successfully.")}catch(i){console.error("Error deleting payment record: ",i),m.error("Failed to delete payment record.")}},Y=e=>{v(e),C(!0)},b=()=>{C(!1),v(null)},U=[{title:"ห้อง",dataIndex:"room",key:"room"},{title:"เดือน",dataIndex:"month",key:"month"},{title:"ปี",dataIndex:"year",key:"year",render:e=>e+543},{title:"ยอดรวม",dataIndex:"total",key:"total",render:e=>`${e} บาท`},{title:"สถานะ",dataIndex:"roomStatus",key:"roomStatus",render:(e,o)=>t.jsx(M,{type:e==="จ่ายแล้ว"?"primary":"default",loading:j===o.id,onClick:()=>B(o.id,e),children:e==="จ่ายแล้ว"?"จ่ายแล้ว":"ค้างชำระ"})},{title:"ภาพหลักฐาน",dataIndex:"uploadedImage",key:"uploadedImage",render:e=>t.jsx("img",{src:e,alt:"Payment Slip",style:{width:"100px",cursor:"pointer"},onClick:()=>Y(e)})},{title:"เวลา",dataIndex:"timestamp",key:"timestamp",render:e=>new Date(e.seconds*1e3).toLocaleString()},{title:"Actions",key:"actions",render:(e,o)=>t.jsx(M,{type:"default",danger:!0,loading:j===o.id,onClick:()=>N(o.id),children:"ลบ"})}],V=Array.from(new Set(c.map(e=>e.year))).sort();return t.jsxs(t.Fragment,{children:[t.jsx(z,{}),t.jsxs("div",{className:"admin-payment-status-container",children:[t.jsx("h3",{children:"จัดการสถานะการชำระเงิน"}),t.jsx(l,{placeholder:"เลือกห้อง",style:{width:200,marginBottom:20},onChange:O,allowClear:!0,children:Array.from(new Set(c.map(e=>e.room))).sort((e,o)=>y.indexOf(e)-y.indexOf(o)).map(e=>t.jsx(l.Option,{value:e,children:e},e))}),t.jsx(l,{placeholder:"เลือกปี",style:{width:200,marginBottom:20,marginLeft:10},onChange:E,allowClear:!0,children:V.map(e=>t.jsx(l.Option,{value:e,children:e+543},e))}),t.jsx(l,{placeholder:"เลือกเดือน",style:{width:200,marginBottom:20,marginLeft:10},onChange:L,allowClear:!0,children:Object.keys(S).map(e=>t.jsx(l.Option,{value:e,children:e},e))}),F?t.jsx(G,{}):t.jsx(J,{columns:U,dataSource:D,rowKey:"id"})]}),t.jsx(H,{visible:A,footer:null,onCancel:b,children:t.jsx("img",{src:R,alt:"Payment Slip",style:{width:"100%"}})}),t.jsx(K,{})]})};export{se as default};
