import{r,j as t}from"./index-Py8q0lCj.js";import{e as U,F as V,j as q,k as z,B as k,d as h,m as v,l as K}from"./Footer-czUV6VvL.js";import{N as T,a as u,S as _,M as $}from"./Navbar-C8zBjWdG.js";import{F as G}from"./Table-8DAdS5fZ.js";import{s as d}from"./index-BZVQ3A21.js";import"./index-D-esWdn6.js";import"./index-C5esm8xC.js";import"./EyeOutlined-Bbd6VZT9.js";const P=["201","202","203","204","205","206","207","208","309","310","311","312","313","314","315","316","225","226","227","228","329","330","331","332"],C={มกราคม:1,กุมภาพันธ์:2,มีนาคม:3,เมษายน:4,พฤษภาคม:5,มิถุนายน:6,กรกฎาคม:7,สิงหาคม:8,กันยายน:9,ตุลาคม:10,พฤศจิกายน:11,ธันวาคม:12},ae=()=>{const[l,I]=r.useState([]),[D,m]=r.useState([]),[F,x]=r.useState(!0),[g,S]=r.useState(null),[y,M]=r.useState(void 0),[p,E]=r.useState(void 0),[R,w]=r.useState(null),[A,j]=r.useState(!1),c=U();r.useEffect(()=>{(async()=>{x(!0);try{const a=q(c,"payments"),n=(await z(a)).docs.map(s=>({id:s.id,...s.data()}));n.sort((s,i)=>s.year===i.year?C[s.month]-C[i.month]:s.year-i.year),I(n),m(n)}catch(a){console.error("Error fetching payment history: ",a),d.error("Failed to load payment data.")}finally{x(!1)}})()},[c]),r.useEffect(()=>{m(l.filter(e=>{const a=y?e.room===y:!0,o=p?e.year===p:!0;return a&&o}))},[y,p,l]);const L=async(e,a)=>{S(e);const o=a==="จ่ายแล้ว"?"ค้างชำระ":"จ่ายแล้ว";try{const n=h(c,"payments",e);await v(n,{roomStatus:o});const s=l.find(i=>i.id===e);if(s){const i=h(c,"invoices",s.invoiceId);await v(i,{roomStatus:o})}m(i=>i.map(f=>f.id===e?{...f,roomStatus:o}:f)),d.success("อัปเดตสถานะเรียบร้อยแล้ว.")}catch(n){console.error("เกิดข้อผิดพลาดในการอัปเดตสถานะ: ",n),d.error("ไม่สามารถอัปเดตสถานะได้.")}finally{S(null)}},O=async e=>{if(window.confirm("Are you sure you want to delete this payment record?"))try{const o=h(c,"payments",e);await K(o),m(n=>n.filter(s=>s.id!==e)),d.success("Payment record deleted successfully.")}catch(o){console.error("Error deleting payment record: ",o),d.error("Failed to delete payment record.")}},B=e=>{w(e),j(!0)},b=()=>{j(!1),w(null)},N=[{title:"ห้อง",dataIndex:"room",key:"room"},{title:"เดือน",dataIndex:"month",key:"month"},{title:"ปี",dataIndex:"year",key:"year",render:e=>e+543},{title:"ยอดรวม",dataIndex:"total",key:"total",render:e=>`${e} บาท`},{title:"สถานะ",dataIndex:"roomStatus",key:"roomStatus",render:(e,a)=>t.jsx(k,{type:e==="paid"?"primary":"default",loading:g===a.id,onClick:()=>L(a.id,e),children:e==="จ่ายแล้ว"?"จ่ายแล้ว":"ค้างชำระ"})},{title:"ภาพหลักฐาน",dataIndex:"uploadedImage",key:"uploadedImage",render:e=>t.jsx("img",{src:e,alt:"Payment Slip",style:{width:"100px",cursor:"pointer"},onClick:()=>B(e)})},{title:"เวลา",dataIndex:"timestamp",key:"timestamp",render:e=>new Date(e.seconds*1e3).toLocaleString()},{title:"Actions",key:"actions",render:(e,a)=>t.jsx(k,{type:"default",danger:!0,loading:g===a.id,onClick:()=>O(a.id),children:"ลบ"})}],Y=Array.from(new Set(l.map(e=>e.year))).sort();return t.jsxs(t.Fragment,{children:[t.jsx(T,{}),t.jsxs("div",{className:"admin-payment-status-container",children:[t.jsx("h3",{children:"จัดการสถานะการชำระเงิน"}),t.jsx(u,{placeholder:"เลือกห้อง",style:{width:200,marginBottom:20},onChange:M,allowClear:!0,children:Array.from(new Set(l.map(e=>e.room))).sort((e,a)=>P.indexOf(e)-P.indexOf(a)).map(e=>t.jsx(u.Option,{value:e,children:e},e))}),t.jsx(u,{placeholder:"เลือกปี",style:{width:200,marginBottom:20,marginLeft:10},onChange:E,allowClear:!0,children:Y.map(e=>t.jsxs(u.Option,{value:e,children:[e+543," "]},e))}),F?t.jsx(_,{size:"large"}):t.jsx(G,{dataSource:D,columns:N,rowKey:"id",pagination:!1}),t.jsx($,{visible:A,footer:null,onCancel:b,children:t.jsx("img",{src:R||"",alt:"Payment Slip Preview",style:{width:"100%"}})})]}),t.jsx(V,{})]})};export{ae as default};
