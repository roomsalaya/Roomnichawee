import{r as l,j as n}from"./index-BJ1mkKvj.js";import{e as J,J as K,F as M,j as q,k as z,B as m,d as R,m as G,r as w,as as E,l as H,u as Q,h as W}from"./Footer-Dfnne6q2.js";import{N as X,a as u,S as Z}from"./Navbar-N01Wbqa6.js";import{F as ee}from"./Table-BXDHCso0.js";import{I as x}from"./index-D6QCiGSK.js";import{U as te,R as ne}from"./index-C9qE3APs.js";import{s as c}from"./index-dqNNSWee.js";import"./index-BQt-TnC-.js";import"./EyeOutlined-BSeyjRwm.js";import"./progress-BPCITOUp.js";const B={มกราคม:1,กุมภาพันธ์:2,มีนาคม:3,เมษายน:4,พฤษภาคม:5,มิถุนายน:6,กรกฎาคม:7,สิงหาคม:8,กันยายน:9,ตุลาคม:10,พฤศจิกายน:11,ธันวาคม:12},pe=()=>{const[o,g]=l.useState([]),[C,I]=l.useState(!0),[S,D]=l.useState(void 0),[k,P]=l.useState(void 0),[d,F]=l.useState({}),h=J(),y=K();l.useEffect(()=>{(async()=>{I(!0);try{const t=q(h,"invoices"),r=(await z(t)).docs.map(s=>({id:s.id,...s.data()}));r.sort((s,p)=>{const j=B[s.month]||0,v=B[p.month]||0;return j-v||s.year-p.year}),g(r)}catch(t){console.error("Error fetching invoices data: ",t)}finally{I(!1)}})()},[h]);const i=async(e,t)=>{try{const a=R(h,"invoices",e),r=o.find(s=>s.id===e);if(r){const s={...r,...t},p=parseFloat(s.rent)||0,j=parseFloat(s.water)||0,v=parseFloat(s.electricity)||0,T=parseFloat(s.fine)||0,U=p+j+v+T;await G(a,{...t,total:U}),c.success("ข้อมูลบิลได้ถูกแก้ไขเรียบร้อยแล้ว!");const $=o.map(f=>f.id===e?{...f,...t,total:U}:f);g($),F(f=>({...f,[e]:!1}))}}catch(a){console.error("Error updating invoice: ",a),c.error("เกิดข้อผิดพลาดในการแก้ไขข้อมูลบิล!")}},L=async e=>{try{const t=o.find(r=>r.id===e);if(t!=null&&t.pdfUrl){const r=w(y,t.pdfUrl);await E(r)}const a=R(h,"invoices",e);await H(a),c.success("ข้อมูลบิลได้ถูกลบเรียบร้อยแล้ว!"),g(o.filter(r=>r.id!==e))}catch(t){console.error("Error deleting invoice: ",t),c.error("เกิดข้อผิดพลาดในการลบข้อมูลบิล!")}},_=async(e,t)=>{try{if(t.pdfUrl){const s=w(y,t.pdfUrl);await E(s)}const a=w(y,`pdfs/${t.id}_${e.name}`);await Q(a,e);const r=await W(a);await i(t.id,{pdfUrl:r}),c.success("อัปโหลด PDF สำเร็จแล้ว!")}catch(a){console.error("Error uploading PDF: ",a),c.error("เกิดข้อผิดพลาดในการอัปโหลด PDF!")}},b=e=>D(e),O=e=>P(e),V=o.filter(e=>(!S||e.room===S)&&(!k||e.year===k)),A=async(e,t)=>{await i(e,{roomStatus:t==="จ่ายแล้ว"?"ค้างชำระ":"จ่ายแล้ว"})},N=e=>{F(t=>({...t,[e]:!t[e]}))},Y=[{title:"ห้อง",dataIndex:"room",key:"room"},{title:"เดือนที่แจ้งหนี้",dataIndex:"month",key:"month"},{title:"ปี (พ.ศ.)",dataIndex:"year",key:"year",render:e=>e+543},{title:"ค่าเช่า (บาท)",dataIndex:"rent",key:"rent",render:(e,t)=>d[t.id]?n.jsx(x,{defaultValue:e,onBlur:a=>i(t.id,{rent:a.target.value})}):n.jsx("span",{children:e})},{title:"ค่าน้ำ (บาท)",dataIndex:"water",key:"water",render:(e,t)=>d[t.id]?n.jsx(x,{defaultValue:e,onBlur:a=>i(t.id,{water:a.target.value})}):n.jsx("span",{children:e})},{title:"ค่าไฟ (บาท)",dataIndex:"electricity",key:"electricity",render:(e,t)=>d[t.id]?n.jsx(x,{defaultValue:e,onBlur:a=>i(t.id,{electricity:a.target.value})}):n.jsx("span",{children:e})},{title:"ค่าปรับ (บาท)",dataIndex:"fine",key:"fine",render:(e,t)=>d[t.id]?n.jsx(x,{defaultValue:e,onBlur:a=>i(t.id,{fine:a.target.value})}):n.jsx("span",{children:e})},{title:"ยอดรวม (บาท)",dataIndex:"total",key:"total"},{title:"สถานะห้อง",dataIndex:"roomStatus",key:"roomStatus",render:(e,t)=>n.jsxs(n.Fragment,{children:[n.jsx("span",{children:e}),n.jsx(m,{onClick:()=>A(t.id,e),style:{marginLeft:8},children:"เปลี่ยนสถานะ"})]})},{title:"ดาวน์โหลด/เปลี่ยน PDF",dataIndex:"pdfUrl",key:"pdfUrl",render:(e,t)=>n.jsxs(n.Fragment,{children:[t.pdfUrl?n.jsx("a",{href:t.pdfUrl,target:"_blank",rel:"noopener noreferrer",children:"ดาวน์โหลด"}):"ไม่มีไฟล์",n.jsx(te,{showUploadList:!1,beforeUpload:a=>(_(a,t),!1),children:n.jsx(m,{icon:n.jsx(ne,{}),style:{marginLeft:8},children:"อัปโหลดใหม่"})})]})},{title:"แก้ไข/บันทึก",key:"edit",render:(e,t)=>n.jsx(m,{onClick:()=>N(t.id),children:d[t.id]?"บันทึก":"แก้ไข"})},{title:"ลบ",key:"delete",render:(e,t)=>n.jsx(m,{onClick:()=>L(t.id),danger:!0,children:"ลบ"})}];return n.jsxs(n.Fragment,{children:[n.jsx(X,{}),n.jsxs("div",{className:"admin-invoices-container",children:[n.jsx("h3",{children:"แก้ไขบิลแจ้งหนี้"}),n.jsxs("div",{style:{marginBottom:20},children:[n.jsx(u,{placeholder:"เลือกห้อง",onChange:b,style:{width:200,marginRight:10},children:["201","202","203","204","205","206","207","208","309","310","311","312","313","314","315","316","225","226","227","228","329","330","331","332"].map(e=>n.jsx(u.Option,{value:e,children:e},e))}),n.jsx(u,{placeholder:"เลือกปี",onChange:O,style:{width:200},children:Array.from(new Set(o.map(e=>e.year))).sort((e,t)=>t-e).map(e=>n.jsx(u.Option,{value:e,children:e+543},e))})]}),C?n.jsx(Z,{}):n.jsx(ee,{columns:Y,dataSource:V,rowKey:"id",pagination:!1})]}),n.jsx(M,{})]})};export{pe as default};
